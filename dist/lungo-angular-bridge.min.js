/*! lungo-angular-bridge 08-05-2013 */
angular.module("Centralway.lungo-angular-bridge",[]);var AppRouter=function(t,n,e){var o=[];n.replace;var a=2,i=1,r=2;n.replace=function(){return n.$$replace=!0,n};var l=function(t){var n=angular.isArray(t)?t:t.split("/");return n.length>a},u=function(n){if(-1===n.indexOf("#")&&(n="#"+n),0===t.dom(n).length)throw Error("No such element with ID ["+n+"]")},c=function(n){var e=n.split("/"),o=""!==e[i]?e[i]:"main";u(o),e.length>a?(u(e[r]),t.Router.article(o,e[r])):t.Router.section(o)},d=function(t){if(0===o.length)return!1;var n=o[o.length-1].split("/"),e=t.split("/");return n[i]===e[i]},s=function(){var n=t.dom('aside[class*="show"]');angular.forEach(n,function(n){t.View.Aside.toggle("#"+t.dom(n).attr("id"))}),t.dom('section[class*="aside"]').removeClass("aside")},p=function(t){return o.length>0&&o[o.length-2]==t.path()&&!l(t.path())},g=function(){return p(n)};e.$on("$routeChangeSuccess",function(){if(s(),p(n)){o.pop();try{t.Router.back()}catch(e){throw console.log("AppRouter::$routeChangeSuccess - caught exception while navigating back to ",n.path()," : ",e),e}}else c(n.path()),d(n.path())||o.push(n.path())});var v=function(){if(2>o.length)throw Error("No back to go back to!");return o[o.length-2]},f=function(){if(0!==o.length){var t=v();n.path(t)}};return{back:f,isBack:g,isSameSection:d}};angular.module("Centralway.lungo-angular-bridge").directive("labAside",function(){var t=function(t){var n={SHOW:Lungo.Constants.CLASS.SHOW},e=Lungo.View.Aside.show,o=Lungo.View.Aside.hide,a=parseInt(document.body.getBoundingClientRect().width/3,10);t.each(function(){var t=!1,i=Lungo.dom(this),r=i.closest("section"),l=Lungo.dom("#"+i.attr("lab-aside"));r.swiping(function(e){if(!r.hasClass("aside")){var o=e.currentTouch.x-e.iniTouch.x,a=Math.abs(e.currentTouch.y-e.iniTouch.y);t=t?!0:o>3*a&&50>o,t?(o=o>256?256:0>o?0:o,l.addClass(n.SHOW),r.vendor("transform","translateX("+o+"px)"),r.vendor("transition-duration","0s")):r.attr("style","")}}),r.swipe(function(n){var i=n.currentTouch.x-n.iniTouch.x;Math.abs(n.currentTouch.y-n.iniTouch.y),r.attr("style",""),i>a&&t?e(l):o(l),t=!1})})};return{restrict:"A",link:function(n,e){var o=e.attr("lab-aside"),a=Lungo.Core.environment().isMobile?"tap":"click";Lungo.dom(e[0]).bind(a,function(t){Lungo.View.Aside.toggle("#"+o),t.preventDefault()}),t(Lungo.dom(e[0]))}}}),angular.module("Centralway.lungo-angular-bridge").directive("labBoot",["$location",function(t){function n(t){return-1===t.indexOf(",")?t:t.split(",")}return function(e,o){Lungo.init({resources:o.attr("resources")&&n(o.attr("resources"))}),AppRouter.instance=AppRouter(Lungo,t,e)}}]),function(t,n){var e="swipe swiping swipeLeft swipeRight swipeDown swipeUp tap hold singleTap doubleTap pinch pinching pinchIn pinchOut rotate rotating rotateLeft rotateRight";angular.forEach(e.split(" "),function(e){var o=e.charAt(0).toUpperCase()+e.slice(1),a="lab"+o;t.directive(a,["$parse",function(t){return{restrict:"A",link:function(o,i,r){var l=t(r[a]);n.dom(i[0]).on(e.toLowerCase(),function(t){t.preventDefault(),o.$apply(function(){l(o,{$event:t})})})}}}])}),t.directive("href",["$location",function(t){return{restrict:"A",link:function(e,o,a){if("A"===o[0].tagName.toUpperCase()){if(void 0!==a.noHref)return console.log("directive:href - explicit unbind, not handling taps"),void 0;var i=a.href;n.dom(o[0]).on("tap",function(){t.path(i)})}}}}])}(angular.module("Centralway.lungo-angular-bridge"),Lungo),angular.module("Centralway.lungo-angular-bridge").directive("labPopup",["popupService",function(t){return{restrict:"A",link:function(n,e,o){var a=o.labPopup,i={};o.controller&&(i.controller=o.controller),e.bind("click",function(){t.load(a,n,i)})}}}]),angular.module("Centralway.lungo-angular-bridge").directive("labView",["$http","$templateCache","$route","$anchorScroll","$compile","$controller","$location","$log",function(t,n,e,o,a,i,r,l){var u=function(t){t.find("[data-count],[data-pull],[data-progress],[data-label],[data-icon],[data-image],[data-title],[data-loading]").removeAttr("data-count").removeAttr("data-pull").removeAttr("data-progress").removeAttr("data-label").removeAttr("data-icon").removeAttr("data-image").removeAttr("data-title").removeAttr("data-loading")},c=function(t){var n=void 0===t,e=n?Lungo.dom('*[class*="lab-view"]'):Lungo.dom(t[0]);return 0===e.length?(l.error("labView::initialiseLoadedContent() - could not find class with lab-view to do a Lungo boot on"),void 0):(n||!e.hasClass("lab-inited-view")?(l.info("labView::viewContentLoaded - booting content"),Lungo.Boot.Data.init("#"+e.attr("id")),u(e),e.addClass("lab-inited-view")):l.warn("labView::initialiseLoadedContent() - lab-view-inited element already exists"),void 0)};return{restrict:"ECA",terminal:!0,link:function(t,n,l){function u(){g&&(g.$destroy(),g=null)}function d(){return Lungo.dom('*[class*="lab-view"]')}function s(t){var n=Lungo.dom('*[class*="lab-old-view"]');n.length>0&&n.remove(),t.removeClass("lab-view").addClass("lab-old-view"),t.length>0&&t.attr("lab-view-old-id",t.attr("id")).removeAttr("id")}function p(){var l=e.current&&e.current.locals,p=l&&l.$template;if(p&&!AppRouter.instance.isSameSection(r.path())){t.$emit("$labViewUpdateStart",null);var f=n.parent(),h=d();s(h);var w=null;if(f.append(p),w=angular.element(f.children()[f.children().length-1]),w.addClass("lab-view"),!w.attr("id"))throw Error("Elements loaded via templates must have an ID attribute");if(AppRouter.instance.isBack(r)){var m=h.data("transition");w.attr("data-transition-origin",m),w.addClass("hide")}c(w),u();var b,$=a(w.contents()),C=e.current;g=C.scope=t.$new(),C.controller&&(l.$scope=g,b=i(C.controller,l),w.contents().data("$ngControllerController",b)),$(g),g.$emit("$viewContentLoaded"),g.$eval(v),o(),t.$emit("labViewUpdateFinished",null)}}var g,v=l.onload||"";t.$on("$routeChangeSuccess",p),p(),t.$on("$viewContentLoaded",function(){c()})}}}]),angular.module("Centralway.lungo-angular-bridge").directive("labWindow",["popupService",function(t){return{restrict:"A",link:function(n,e,o){var a=o.labWindow,i={};o.transition&&(i.transition=o.transition),o.controller&&(i.controller=o.controller),e.bind("click",function(){t.showWindow(a,n,i)})}}}]),angular.module("Centralway.lungo-angular-bridge").factory("popupService",["$http","$compile","$timeout",function(t,n,e){var o={};return o.getPopup=function(t){return!o.popupElement&&t&&(o.popupElement=$$('<div class="notification"><div class="window show"></div></div>'),$$(window.document.body).append(o.popupElement)),o.popupElement},o.compileAndRunPopup=function(t,e){var o=angular.element(t[0]);n(o)(e),t.show()},o.load=function(n,e,a){var i="<div ng-include=\"'"+n+"'\"></div>";t.get(void 0).success(function(){var t=o.getPopup(!0),n=t;n.find("div").html(i),o.compileAndRunPopup(n,e,a)})},o.getWindow=function(t){if(!o.windowElement&&t){var n=Math.floor(1e6*Math.random()),e=n+(new Date).getTime(),a=$$('<section id="section_'+e+'" ng-include=""></section>');$$(window.document.body).append(a),o.windowElement=a}return o.windowElement},o.showWindow=function(t,a,i){var r=i.transition||"",l=o.getWindow(!0);l.attr("ng-include","'"+t+"'"),l.attr("data-transition",r),i.controller&&l.attr("ng-controller",i.controller);var u=angular.element(l[0]);n(u)(a),a.$on("$includeContentLoaded",function(){Lungo.Boot.Data.init("#"+l.attr("id"))}),e(function(){Lungo.Router.section(l.attr("id"))},1)},o.close=function(){var t=o.getPopup(),n=o.getWindow();t&&(t.hide(),t.remove(),delete o.popupElement),n&&(Lungo.Router.back(),e(function(){n.remove(),delete o.windowElement},400))},o}]);